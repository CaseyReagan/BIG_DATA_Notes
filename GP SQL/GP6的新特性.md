#  GP6的新特性
本文借鉴：1. https://zhuanlan.zhihu.com/p/266443019   

2.https://cn.greenplum.org/?hmsr=%E6%80%9D%E5%90%A6&hmpl&hmcu&hmkw&hmci

## 总结
对生产环境来说，GP6最重要的性能提升在于并发性上的改进尤为显著，内核上从PostgreSQLV8.3升级到了V9.4，对OLTP和全局锁的优化，据说可以将查询写入性能提升70倍。（暂时未亲自使用过，看网上反馈需要调参才能做到）   
***

### （一）背景
项目涉及要把GP4的相关数据表和任务，从GP4升级迁移到GP5，然后未来再从GP5迁移到GP6，并且部门取消了之前说的可能会采购Doris的计划，而采购GP6。并且听说GP6可以解决GP4和GP5在运行中遇到的大部分卡死，卡慢的问题，WHY？How？
***
   
### （二）GP6升级简介
GP是基于PostgreSQL的MPP数据库，在2017年的GP5将PostgreSQL的内核版本升级到了V8.3，而2019年9月4日发布的Greenplum 6.0对内核进行了增强，升级了对应Postgres版本至v9.4，获得了更多Postgres的兼容特性；大幅增强了OLTP型负载的处理能力，从而更加胜任流计算和HTAP的场景。此外，Greenplum 6.0的其它重要更新还包括：分布式死锁检测、支持复制表，在线扩容，磁盘配额，支持Zstandard压缩算法，自动master切换，GP-GP集群间高效查询，基于流复制的全新高可用机制等。   
   
更新总结，关键更新：
1. 复制表
2. 集群在线扩容
3. 跨集群查询
4. 磁盘配额管理
5. Zstd压缩
6. 更多的K8S支持
7. OLTP操作性能提高
8. 轻量级锁
9. DBeaver官方支持
***   

### （三）GP6的OLTP性能提升70倍
（见笔记《OLTP和OLAP还有HTAP数据库是什么》里关于OLTP和OLAP的内容）OLTP性能的大幅提升的原因，第一个要素来自于全局死锁检测（GDD），该技术在美国申请了专利，但最终全部开源。老版本GP上update使用的是表锁，性能较差，通过全局死锁检测技术，降低为行级锁，性能大幅提升。GDD的基本逻辑是收集每个segment锁依赖关系图，在master上重建整个集群的锁依赖关系图，并检测是否有环。具体实现细节可以参考Greenplum中文社区（cn.greeplum.org）上的设计文档。
+ 第二个要素是通过复制表完成的。复制表即每个segment都有表的全部数据，因而不需要网络数据传输，还可使用索引。   

+ 第三个要素是多核锁优化。当通过测试发现高并发时，性能不增反降，然后通过多种方式定位到 procarray 锁的竞争严重。   

+ 第四个要素是事务优化。只读事务不需要分布式快照，也不需要2PC； 而单节点查询也可以对两阶段提交进行优化。   

+ 最后是内核升级，PostgreSQL本身的性能在版本升级的过程中不断提升，Greenplum 通过升级自然继承了所有PostgreSQL升级带来的优势。   
***

### （四）GP6的HTAP功能。
Greenpum作为一个集成处理平台，其功能远远超出了数据仓库。6.0的发布使得Greenplum成为一款企业级的HTAP数据库。作为一个集成平台，Greenplum具有很好的混合负载处理能力。在6.0中，经测试，TPCB提高了70倍。单点插上，实验环境中，SELECT可达14w/s，INSERT 4.6w, UPDATE 2.4w，这个性能可以满足很多的OLTP场景。Greenplum可以支持结构化数据、半结构化数据、非结构化数据，包括 JSON、KV、Text、GIS、时序、图、图像等。6.0版本对流数据也有很好的支持，包括流式加载，流式处理，和时序数据的分析。      

在对混合负载的支持上，Greenplum还具有其他支撑HTAP的技术，包括多模数据存储、对包括并发度、CPU配额、CPU绑定、内存配额和磁盘配额在内的多种资源管理的支持，并提供了完善的安全特性。这些支持使得Greenplum可以满足用户使用一套系统支持全部AP、TP和流式业务，避免复杂的ETL，维护多种产品，大大提高投入产出比。
***

### （五）GP6的集群在线扩容
另一个内核特性是弹性，包括数据弹性分布、计算的弹性；这两方面在6.0版本中都做好了基础设施。除了弹性，6.0版本中的数据分布策略也更灵活，默认根据数据类型的hash函数计算数据分布。6.0中海支持自定义数据分布策略。基于这些技术，Greenplum 6.0版本实现了在线扩容，可以做到不停机，不停业务，并且通过一致性哈希，大幅降低数据移动量。  
***

### （六）GP6对机器学期和AI算法的支持
除了传统的数仓， Greenplum 还通过Apache 顶级开源项目 MADLib 实现了对数据库内高级分析的支持。MADLib 提供了50多种机器学习算法，并为数据科学家提供了很多实用工具，譬如模型交叉验证，工作流等。今年 madlib 开始支持AI深度学习，集成了Tensorflow、teras 等，利用 GPU 的计算能力执行深度学习任务。   

如果madlib不能满足你的需求，Greenpum还提供了2种方式让用户得以自行进行扩展。第一种方式是通过Procedure Language(PL)， 另一种方式则是为开发人员提供透明的计算能力，首先会支持R，这就是GreenplumR项目。 通过这个项目，R程序员可以对 SQL 的结果调用 R 的函数，整个过程对R开发人员透明，同时也可以获得Greenplum提供的强大的并行计算能力。
***

